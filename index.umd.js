(function(a,b){typeof exports=="object"&&typeof module<"u"?b(exports):typeof define=="function"&&define.amd?define(["exports"],b):(a=typeof globalThis<"u"?globalThis:a||self,b(a.Wasmoon={}))})(this,function(exports){"use strict";var b=class{constructor(Q,R){this.target=Q,this.options=R}};function c(Q,R){return new b(Q,R)}var d=class extends Array{},e=class extends Number{};let f=function(Q){return Q[Q.Ok=0]="Ok",Q[Q.Yield=1]="Yield",Q[Q.ErrorRun=2]="ErrorRun",Q[Q.ErrorSyntax=3]="ErrorSyntax",Q[Q.ErrorMem=4]="ErrorMem",Q[Q.ErrorErr=5]="ErrorErr",Q[Q.ErrorFile=6]="ErrorFile",Q}({});const g=4,h=-1,i=1e6,j=-i-1e3;let k=function(Q){return Q[Q.None=-1]="None",Q[Q.Nil=0]="Nil",Q[Q.Boolean=1]="Boolean",Q[Q.LightUserdata=2]="LightUserdata",Q[Q.Number=3]="Number",Q[Q.String=4]="String",Q[Q.Table=5]="Table",Q[Q.Function=6]="Function",Q[Q.Userdata=7]="Userdata",Q[Q.Thread=8]="Thread",Q}({}),l=function(Q){return Q[Q.Call=0]="Call",Q[Q.Ret=1]="Ret",Q[Q.Line=2]="Line",Q[Q.Count=3]="Count",Q[Q.TailCall=4]="TailCall",Q}({}),m=function(Q){return Q[Q.Call=1]="Call",Q[Q.Ret=2]="Ret",Q[Q.Line=4]="Line",Q[Q.Count=8]="Count",Q}({}),n=function(Q){return Q.Base="_G",Q.Coroutine="coroutine",Q.Table="table",Q.IO="io",Q.OS="os",Q.String="string",Q.UTF8="utf8",Q.Math="math",Q.Debug="debug",Q.Package="package",Q}({});var o=class extends Error{};const p=1e3;var q=class Q{address;lua;typeExtensions;closed=!1;hookFunctionPointer;timeout;parent;constructor(R,S,T,U){this.lua=R,this.typeExtensions=S,this.address=T,this.parent=U}newThread(){const R=this.lua.lua_newthread(this.address);if(!R)throw Error("lua_newthread returned a null pointer");return new Q(this.lua,this.typeExtensions,R,this.parent||this)}resetThread(){this.assertOk(this.lua.lua_resetthread(this.address))}loadString(R,S){const T=this.lua.module.lengthBytesUTF8(R),U=T+1,V=this.lua.module._malloc(U);try{this.lua.module.stringToUTF8(R,V,U),this.assertOk(this.lua.luaL_loadbufferx(this.address,V,T,S??V,null))}finally{this.lua.module._free(V)}}loadFile(R){this.assertOk(this.lua.luaL_loadfilex(this.address,R,null))}resume(R=0){const S=this.lua.module._malloc(g);try{this.lua.module.setValue(S,0,"i32");const T=this.lua.lua_resume(this.address,null,R,S);return{result:T,resultCount:this.lua.module.getValue(S,"i32")}}finally{this.lua.module._free(S)}}getTop(){return this.lua.lua_gettop(this.address)}setTop(R){this.lua.lua_settop(this.address,R)}remove(R){return this.lua.lua_remove(this.address,R)}setField(R,S,T){R=this.lua.lua_absindex(this.address,R),this.pushValue(T),this.lua.lua_setfield(this.address,R,S)}async run(R=0,S){const T=this.timeout;try{S?.timeout!==void 0&&this.setTimeout(Date.now()+S.timeout);let U=this.resume(R);for(;U.result===f.Yield;){if(this.timeout&&Date.now()>this.timeout)throw U.resultCount>0&&this.pop(U.resultCount),new o("thread timeout exceeded");if(U.resultCount>0){const V=this.getValue(-1);this.pop(U.resultCount),V===Promise.resolve(V)?await V:await new Promise(W=>setImmediate(W))}else await new Promise(V=>setImmediate(V));U=this.resume(0)}return this.assertOk(U.result),this.getStackValues()}finally{S?.timeout!==void 0&&this.setTimeout(T)}}runSync(R=0){const S=this.getTop()-R-1;return this.assertOk(this.lua.lua_pcallk(this.address,R,h,0,0,null)),this.getStackValues(S)}pop(R=1){this.lua.lua_pop(this.address,R)}call(R,...S){const T=this.lua.lua_getglobal(this.address,R);if(T!==k.Function)throw Error(`A function of type '${T}' was pushed, expected is ${k.Function}`);for(const V of S)this.pushValue(V);const U=this.getTop()-S.length-1;return this.lua.lua_callk(this.address,S.length,h,0,null),this.getStackValues(U)}getStackValues(R=0){const S=this.getTop()-R,T=new d(S);for(let U=0;U<S;U++)T[U]=this.getValue(R+U+1);return T}stateToThread(R){return R===this.parent?.address?this.parent:new Q(this.lua,this.typeExtensions,R,this.parent||this)}pushValue(R,S){const T=this.getValueDecorations(R),U=T.target;if(U instanceof Q){const W=this.lua.lua_pushthread(U.address)===1;W||this.lua.lua_xmove(U.address,this.address,1);return}const V=this.getTop();switch(typeof U){case"undefined":this.lua.lua_pushnil(this.address);break;case"number":Number.isInteger(U)?this.lua.lua_pushinteger(this.address,BigInt(U)):this.lua.lua_pushnumber(this.address,U);break;case"string":this.lua.lua_pushstring(this.address,U);break;case"boolean":this.lua.lua_pushboolean(this.address,U?1:0);break;default:if(this.typeExtensions.find(W=>W.extension.pushValue(this,T,S)))break;if(U===null){this.lua.lua_pushnil(this.address);break}throw Error(`The type '${typeof U}' is not supported by Lua`)}if(T.options.metatable&&this.setMetatable(-1,T.options.metatable),this.getTop()!==V+1)throw Error(`pushValue expected stack size ${V+1}, got ${this.getTop()}`)}setMetatable(R,S){if(R=this.lua.lua_absindex(this.address,R),this.lua.lua_getmetatable(this.address,R)){this.pop(1);const T=this.getMetatableName(R);throw Error(`data already has associated metatable: ${T||"unknown name"}`)}this.pushValue(S),this.lua.lua_setmetatable(this.address,R)}getMetatableName(R){const S=this.lua.luaL_getmetafield(this.address,R,"__name");if(S===k.Nil)return;if(S!==k.String){this.pop(1);return}const T=this.lua.lua_tolstring(this.address,-1,null);return this.pop(1),T}getValue(R,S,T){R=this.lua.lua_absindex(this.address,R);const U=S??this.lua.lua_type(this.address,R);switch(U){case k.None:return;case k.Nil:return null;case k.Number:return this.lua.lua_tonumberx(this.address,R,null);case k.String:return this.lua.lua_tolstring(this.address,R,null);case k.Boolean:return!!this.lua.lua_toboolean(this.address,R);case k.Thread:return this.stateToThread(this.lua.lua_tothread(this.address,R));default:{let V;(U===k.Table||U===k.Userdata)&&(V=this.getMetatableName(R));const W=this.typeExtensions.find(X=>X.extension.isType(this,R,U,V));return W?W.extension.getValue(this,R,T):(console.warn(`The type '${this.lua.lua_typename(this.address,U)}' returned is not supported on JS`),new e(this.lua.lua_topointer(this.address,R)))}}}close(){if(this.isClosed())return;this.hookFunctionPointer&&this.lua.module.removeFunction(this.hookFunctionPointer),this.closed=!0}setTimeout(R){R&&R>0?(this.hookFunctionPointer||(this.hookFunctionPointer=this.lua.module.addFunction(()=>{Date.now()>R&&(this.pushValue(new o("thread timeout exceeded")),this.lua.lua_error(this.address))},"vii")),this.lua.lua_sethook(this.address,this.hookFunctionPointer,m.Count,p),this.timeout=R):this.hookFunctionPointer&&(this.hookFunctionPointer=void 0,this.timeout=void 0,this.lua.lua_sethook(this.address,null,0,0))}getTimeout(){return this.timeout}getPointer(R){return new e(this.lua.lua_topointer(this.address,R))}isClosed(){return!this.address||this.closed||!!this.parent?.isClosed()}indexToString(R){const S=this.lua.luaL_tolstring(this.address,R,null);return this.pop(),S}dumpStack(R=console.log){const S=this.getTop();for(let T=1;T<=S;T++){const U=this.lua.lua_type(this.address,T),V=this.lua.lua_typename(this.address,U),W=this.getPointer(T),X=this.indexToString(T),Y=this.getValue(T,U);R(T,V,W,X,Y)}}assertOk(R){if(R!==f.Ok&&R!==f.Yield){const S=f[R],T=Error(`Lua Error(${S}/${R})`);if(this.getTop()>0)if(R===f.ErrorMem)T.message=this.lua.lua_tolstring(this.address,-1,null);else{const U=this.getValue(-1);U instanceof Error&&(T.stack=U.stack),T.message=this.indexToString(-1)}if(R!==f.ErrorMem)try{this.lua.luaL_traceback(this.address,this.address,null,1);const U=this.lua.lua_tolstring(this.address,-1,null);U.trim()!=="stack traceback:"&&(T.message=`${T.message}\n${U}`),this.pop(1)}catch(U){console.warn("Failed to generate stack trace",U)}throw T}}getValueDecorations(R){return R instanceof b?R:new b(R,{})}},r=class extends q{memoryStats;allocatorFunctionPointer;constructor(Q,R){if(R){const S={memoryUsed:0},T=Q.module.addFunction((V,W,X,Y)=>{if(Y===0)return W&&(S.memoryUsed-=X,Q.module._free(W)),0;const Z=W?Y-X:Y,$=S.memoryUsed+Z;if(Y>X&&S.memoryMax&&$>S.memoryMax)return 0;const _=Q.module._realloc(W,Y);return _&&(S.memoryUsed=$),_},"iiiii"),U=Q.lua_newstate(T,null);if(!U)throw Q.module.removeFunction(T),Error("lua_newstate returned a null pointer");super(Q,[],U),this.memoryStats=S,this.allocatorFunctionPointer=T}else super(Q,[],Q.luaL_newstate());if(this.isClosed())throw Error("Global state could not be created (probably due to lack of memory)")}close(){if(this.isClosed())return;super.close(),this.lua.lua_close(this.address),this.allocatorFunctionPointer&&this.lua.module.removeFunction(this.allocatorFunctionPointer);for(const Q of this.typeExtensions)Q.extension.close()}registerTypeExtension(Q,R){this.typeExtensions.push({extension:R,priority:Q}),this.typeExtensions.sort((S,T)=>T.priority-S.priority)}loadLibrary(Q){switch(Q){case n.Base:this.lua.luaopen_base(this.address);break;case n.Coroutine:this.lua.luaopen_coroutine(this.address);break;case n.Table:this.lua.luaopen_table(this.address);break;case n.IO:this.lua.luaopen_io(this.address);break;case n.OS:this.lua.luaopen_os(this.address);break;case n.String:this.lua.luaopen_string(this.address);break;case n.UTF8:this.lua.luaopen_utf8(this.address);break;case n.Math:this.lua.luaopen_math(this.address);break;case n.Debug:this.lua.luaopen_debug(this.address);break;case n.Package:this.lua.luaopen_package(this.address);break}this.lua.lua_setglobal(this.address,Q)}get(Q){const R=this.lua.lua_getglobal(this.address,Q),S=this.getValue(-1,R);return this.pop(),S}set(Q,R){this.pushValue(R),this.lua.lua_setglobal(this.address,Q)}getTable(Q,R){const S=this.getTop(),T=this.lua.lua_getglobal(this.address,Q);try{if(T!==k.Table)throw TypeError(`Unexpected type in ${Q}. Expected ${k[k.Table]}. Got ${k[T]}.`);R(S+1)}finally{this.getTop()!==S+1&&console.warn(`getTable: expected stack size ${S} got ${this.getTop()}`),this.setTop(S)}}getMemoryUsed(){return this.getMemoryStatsRef().memoryUsed}getMemoryMax(){return this.getMemoryStatsRef().memoryMax}setMemoryMax(Q){this.getMemoryStatsRef().memoryMax=Q}getMemoryStatsRef(){if(!this.memoryStats)throw Error("Memory allocations is not being traced, please build engine with { traceAllocations: true }");return this.memoryStats}},s=class{name;thread;constructor(Q,R){this.thread=Q,this.name=R}isType(Q,R,S,T){return S===k.Userdata&&T===this.name}getValue(Q,R,S){const T=Q.lua.luaL_testudata(Q.address,R,this.name);if(!T)throw Error(`data does not have the expected metatable: ${this.name}`);const U=Q.lua.module.getValue(T,"*");return Q.lua.getRef(U)}pushValue(Q,R,S){const{target:T}=R,U=Q.lua.ref(T),V=Q.lua.lua_newuserdatauv(Q.address,g,0);if(Q.lua.module.setValue(V,U,"*"),k.Nil===Q.lua.luaL_getmetatable(Q.address,this.name))throw Q.pop(2),Error(`metatable not found: ${this.name}`);return Q.lua.lua_setmetatable(Q.address,-2),!0}},t=class extends s{gcPointer;constructor(Q,R){if(super(Q,"js_error"),this.gcPointer=Q.lua.module.addFunction(S=>{const T=Q.lua.luaL_checkudata(S,1,this.name),U=Q.lua.module.getValue(T,"*");return Q.lua.unref(U),f.Ok},"ii"),Q.lua.luaL_newmetatable(Q.address,this.name)){const S=Q.lua.lua_gettop(Q.address);Q.lua.lua_pushstring(Q.address,"protected metatable"),Q.lua.lua_setfield(Q.address,S,"__metatable"),Q.lua.lua_pushcclosure(Q.address,this.gcPointer,0),Q.lua.lua_setfield(Q.address,S,"__gc"),Q.pushValue((T,U)=>U==="message"?T.message:null),Q.lua.lua_setfield(Q.address,S,"__index"),Q.pushValue(T=>T.message),Q.lua.lua_setfield(Q.address,S,"__tostring")}Q.lua.lua_pop(Q.address,1),R&&Q.set("Error",{create:S=>{if(S&&typeof S!="string")throw Error("message must be a string");return Error(S)}})}pushValue(Q,R){return R.target instanceof Error?super.pushValue(Q,R):!1}close(){this.thread.lua.module.removeFunction(this.gcPointer)}};function u(Q,R){return new t(Q,R)}var v=class{constructor(Q){this.count=Q}};function w(Q,R){return new b(Q,R)}var x=class extends s{functionRegistry=typeof FinalizationRegistry<"u"?new FinalizationRegistry(Q=>{this.thread.isClosed()||this.thread.lua.luaL_unref(this.thread.address,j,Q)}):void 0;gcPointer;functionWrapper;callbackContext;callbackContextIndex;options;constructor(Q,R){super(Q,"js_function"),this.options=R,this.callbackContext=Q.newThread(),this.callbackContextIndex=this.thread.lua.luaL_ref(Q.address,j),this.functionRegistry||console.warn("FunctionTypeExtension: FinalizationRegistry not found. Memory leaks likely."),this.gcPointer=Q.lua.module.addFunction(S=>{Q.lua.luaL_checkudata(S,1,this.name);const T=Q.lua.luaL_checkudata(S,1,this.name),U=Q.lua.module.getValue(T,"*");return Q.lua.unref(U),f.Ok},"ii"),Q.lua.luaL_newmetatable(Q.address,this.name)&&(Q.lua.lua_pushstring(Q.address,"__gc"),Q.lua.lua_pushcclosure(Q.address,this.gcPointer,0),Q.lua.lua_settable(Q.address,-3),Q.lua.lua_pushstring(Q.address,"__metatable"),Q.lua.lua_pushstring(Q.address,"protected metatable"),Q.lua.lua_settable(Q.address,-3)),Q.lua.lua_pop(Q.address,1),this.functionWrapper=Q.lua.module.addFunction(S=>{const T=Q.stateToThread(S),U=Q.lua.luaL_checkudata(S,Q.lua.lua_upvalueindex(1),this.name),V=Q.lua.module.getValue(U,"*"),{target:W,options:X}=Q.lua.getRef(V),Y=T.getTop(),Z=[];if(X.receiveThread&&Z.push(T),X.receiveArgsQuantity)Z.push(Y);else for(let $=1;$<=Y;$++){const _=T.getValue($);($!==1||!X?.self||_!==X.self)&&Z.push(_)}try{const $=W.apply(X?.self,Z);if($===void 0)return 0;if($ instanceof v)return $.count;if($ instanceof d){for(const _ of $)T.pushValue(_);return $.length}return T.pushValue($),1}catch($){if($===1/0)throw $;return T.pushValue($),T.lua.lua_error(T.address)}},"ii")}close(){this.thread.lua.module.removeFunction(this.gcPointer),this.thread.lua.module.removeFunction(this.functionWrapper),this.callbackContext.close(),this.callbackContext.lua.luaL_unref(this.callbackContext.address,j,this.callbackContextIndex)}isType(Q,R,S){return S===k.Function}pushValue(Q,R){if(typeof R.target!="function")return!1;const S=Q.lua.ref(R),T=Q.lua.lua_newuserdatauv(Q.address,g,0);if(Q.lua.module.setValue(T,S,"*"),k.Nil===Q.lua.luaL_getmetatable(Q.address,this.name))throw Q.pop(1),Q.lua.unref(S),Error(`metatable not found: ${this.name}`);return Q.lua.lua_setmetatable(Q.address,-2),Q.lua.lua_pushcclosure(Q.address,this.functionWrapper,1),!0}getValue(Q,R){Q.lua.lua_pushvalue(Q.address,R);const S=Q.lua.luaL_ref(Q.address,j),T=(...U)=>{if(this.callbackContext.isClosed()){console.warn("Tried to call a function after closing lua state");return}const V=this.callbackContext.newThread();try{const W=V.lua.lua_rawgeti(V.address,j,BigInt(S));if(W!==k.Function){const Y=V.lua.luaL_getmetafield(V.address,-1,"__call");if(V.pop(),Y!==k.Function)throw Error(`A value of type '${W}' was pushed but it is not callable`)}for(const Y of U)V.pushValue(Y);this.options?.functionTimeout&&V.setTimeout(Date.now()+this.options.functionTimeout);const X=V.lua.lua_pcallk(V.address,U.length,1,0,0,null);if(X===f.Yield)throw Error("cannot yield in callbacks from javascript");if(V.assertOk(X),V.getTop()>0)return V.getValue(-1);return}finally{V.close(),this.callbackContext.pop()}};return this.functionRegistry?.register(T,S),T}};function y(Q,R){return new x(Q,R)}var z=class extends s{gcPointer;constructor(Q){if(super(Q,"js_null"),this.gcPointer=Q.lua.module.addFunction(R=>{const S=Q.lua.luaL_checkudata(R,1,this.name),T=Q.lua.module.getValue(S,"*");return Q.lua.unref(T),f.Ok},"ii"),Q.lua.luaL_newmetatable(Q.address,this.name)){const R=Q.lua.lua_gettop(Q.address);Q.lua.lua_pushstring(Q.address,"protected metatable"),Q.lua.lua_setfield(Q.address,R,"__metatable"),Q.lua.lua_pushcclosure(Q.address,this.gcPointer,0),Q.lua.lua_setfield(Q.address,R,"__gc"),Q.pushValue(()=>null),Q.lua.lua_setfield(Q.address,R,"__index"),Q.pushValue(()=>"null"),Q.lua.lua_setfield(Q.address,R,"__tostring"),Q.pushValue((S,T)=>S===T),Q.lua.lua_setfield(Q.address,R,"__eq")}Q.lua.lua_pop(Q.address,1),super.pushValue(Q,new b({},{})),Q.lua.lua_setglobal(Q.address,"null")}getValue(Q,R){const S=Q.lua.luaL_testudata(Q.address,R,this.name);if(!S)throw Error(`data does not have the expected metatable: ${this.name}`);return null}pushValue(Q,R){return R?.target===null?(Q.lua.lua_getglobal(Q.address,"null"),!0):!1}close(){this.thread.lua.module.removeFunction(this.gcPointer)}};function A(Q){return new z(Q)}const B=Q=>Q&&(Promise.resolve(Q)===Q||typeof Q.then=="function");var C=class extends s{gcPointer;constructor(Q,R){if(super(Q,"js_promise"),this.gcPointer=Q.lua.module.addFunction(S=>{const T=Q.lua.luaL_checkudata(S,1,this.name),U=Q.lua.module.getValue(T,"*");return Q.lua.unref(U),f.Ok},"ii"),Q.lua.luaL_newmetatable(Q.address,this.name)){const S=Q.lua.lua_gettop(Q.address);Q.lua.lua_pushstring(Q.address,"protected metatable"),Q.lua.lua_setfield(Q.address,S,"__metatable"),Q.lua.lua_pushcclosure(Q.address,this.gcPointer,0),Q.lua.lua_setfield(Q.address,S,"__gc");const T=U=>{if(!B(U))throw Error("self instance is not a promise");return!0};Q.pushValue({next:(U,...V)=>T(U)&&U.then(...V),catch:(U,...V)=>T(U)&&U.catch(...V),finally:(U,...V)=>T(U)&&U.finally(...V),await:w((U,V)=>{if(T(V),U.address===Q.address)throw Error("cannot await in the main thread");let W;const X=V.then(Z=>{W={status:"fulfilled",value:Z}}).catch(Z=>{W={status:"rejected",value:Z}}),Y=this.thread.lua.module.addFunction(Z=>{if(!W)return Q.lua.lua_yieldk(U.address,0,0,Y);this.thread.lua.module.removeFunction(Y);const $=Q.stateToThread(Z);if(W.status==="rejected")return $.pushValue(W.value||Error("promise rejected with no error")),this.thread.lua.lua_error(Z);if(W.value instanceof v)return W.value.count;if(W.value instanceof d){for(const _ of W.value)$.pushValue(_);return W.value.length}return $.pushValue(W.value),1},"iiii");return U.pushValue(X),new v(Q.lua.lua_yieldk(U.address,1,0,Y))},{receiveThread:!0})}),Q.lua.lua_setfield(Q.address,S,"__index"),Q.pushValue((U,V)=>U===V),Q.lua.lua_setfield(Q.address,S,"__eq")}Q.lua.lua_pop(Q.address,1),R&&Q.set("Promise",{create:S=>new Promise(S),all:S=>{if(!Array.isArray(S))throw Error("argument must be an array of promises");return Promise.all(S.map(T=>Promise.resolve(T)))},resolve:S=>Promise.resolve(S)})}close(){this.thread.lua.module.removeFunction(this.gcPointer)}pushValue(Q,R){return B(R.target)?super.pushValue(Q,R):!1}};function D(Q,R){return new C(Q,R)}function E(Q,R){return new b(Q,R||{})}var F=class extends s{gcPointer;constructor(Q){if(super(Q,"js_proxy"),this.gcPointer=Q.lua.module.addFunction(R=>{const S=Q.lua.luaL_checkudata(R,1,this.name),T=Q.lua.module.getValue(S,"*");return Q.lua.unref(T),f.Ok},"ii"),Q.lua.luaL_newmetatable(Q.address,this.name)){const R=Q.lua.lua_gettop(Q.address);Q.lua.lua_pushstring(Q.address,"protected metatable"),Q.lua.lua_setfield(Q.address,R,"__metatable"),Q.lua.lua_pushcclosure(Q.address,this.gcPointer,0),Q.lua.lua_setfield(Q.address,R,"__gc"),Q.pushValue((S,T)=>{switch(typeof T){case"number":--T;case"string":break;default:throw Error("Only strings or numbers can index js objects")}const U=S[T];return typeof U=="function"?w(U,{self:S}):U}),Q.lua.lua_setfield(Q.address,R,"__index"),Q.pushValue((S,T,U)=>{switch(typeof T){case"number":--T;case"string":break;default:throw Error("Only strings or numbers can index js objects")}S[T]=U}),Q.lua.lua_setfield(Q.address,R,"__newindex"),Q.pushValue(S=>S.toString?.()??typeof S),Q.lua.lua_setfield(Q.address,R,"__tostring"),Q.pushValue(S=>S.length||0),Q.lua.lua_setfield(Q.address,R,"__len"),Q.pushValue(S=>{const T=Object.getOwnPropertyNames(S);let U=0;return d.of(()=>{const V=d.of(T[U],S[T[U]]);return U++,V},S,null)}),Q.lua.lua_setfield(Q.address,R,"__pairs"),Q.pushValue((S,T)=>S===T),Q.lua.lua_setfield(Q.address,R,"__eq"),Q.pushValue((S,...T)=>(T[0]===S&&T.shift(),S(...T))),Q.lua.lua_setfield(Q.address,R,"__call")}Q.lua.lua_pop(Q.address,1)}isType(Q,R,S,T){return S===k.Userdata&&T===this.name}getValue(Q,R){const S=Q.lua.lua_touserdata(Q.address,R),T=Q.lua.module.getValue(S,"*");return Q.lua.getRef(T)}pushValue(Q,R){const{target:S,options:T}=R;if(T.proxy===void 0){if(S==null)return!1;if(typeof S!="object"){const U=typeof S=="function"&&S.prototype?.constructor===S&&S.toString().startsWith("class ");if(!U)return!1}if(B(S))return!1}else if(T.proxy===!1)return!1;return T.metatable&&!(T.metatable instanceof b)?(R.options.metatable=E(T.metatable,{proxy:!1}),!1):super.pushValue(Q,R)}close(){this.thread.lua.module.removeFunction(this.gcPointer)}};function G(Q){return new F(Q)}var H=class extends s{constructor(Q){super(Q,"js_table")}close(){}isType(Q,R,S){return S===k.Table}getValue(Q,R,S){const T=S||new Map,U=Q.lua.lua_topointer(Q.address,R);let V=T.get(U);if(!V){const W=this.readTableKeys(Q,R),X=W.length>0&&W.every((Y,Z)=>Y===String(Z+1));V=X?[]:{},T.set(U,V),this.readTableValues(Q,R,T,V)}return V}pushValue(Q,{target:R},S){if(typeof R!="object"||R===null)return!1;const T=S||new Map,U=T.get(R);if(U!==void 0)return Q.lua.lua_rawgeti(Q.address,j,BigInt(U)),!0;try{const V=Q.getTop()+1,W=(X,Y)=>{Q.lua.lua_createtable(Q.address,X,Y);const Z=Q.lua.luaL_ref(Q.address,j);T.set(R,Z),Q.lua.lua_rawgeti(Q.address,j,BigInt(Z))};if(Array.isArray(R)){W(R.length,0);for(let X=0;X<R.length;X++)Q.pushValue(X+1,T),Q.pushValue(R[X],T),Q.lua.lua_settable(Q.address,V)}else for(const X in W(0,Object.getOwnPropertyNames(R).length),R)Q.pushValue(X,T),Q.pushValue(R[X],T),Q.lua.lua_settable(Q.address,V)}finally{if(S===void 0)for(const V of T.values())Q.lua.luaL_unref(Q.address,j,V)}return!0}readTableKeys(Q,R){const S=[];for(Q.lua.lua_pushnil(Q.address);Q.lua.lua_next(Q.address,R);){const T=Q.indexToString(-2);S.push(T),Q.pop()}return S}readTableValues(Q,R,S,T){const U=Array.isArray(T);for(Q.lua.lua_pushnil(Q.address);Q.lua.lua_next(Q.address,R);){const V=Q.indexToString(-2),W=Q.getValue(-1,void 0,S);U?T.push(W):T[V]=W,Q.pop()}}};function aa(Q){return new H(Q)}function I(Q){return new b(Q,{reference:!0})}var J=class extends s{gcPointer;constructor(Q){if(super(Q,"js_userdata"),this.gcPointer=Q.lua.module.addFunction(R=>{const S=Q.lua.luaL_checkudata(R,1,this.name),T=Q.lua.module.getValue(S,"*");return Q.lua.unref(T),f.Ok},"ii"),Q.lua.luaL_newmetatable(Q.address,this.name)){const R=Q.lua.lua_gettop(Q.address);Q.lua.lua_pushstring(Q.address,"protected metatable"),Q.lua.lua_setfield(Q.address,R,"__metatable"),Q.lua.lua_pushcclosure(Q.address,this.gcPointer,0),Q.lua.lua_setfield(Q.address,R,"__gc")}Q.lua.lua_pop(Q.address,1)}isType(Q,R,S,T){return S===k.Userdata&&T===this.name}getValue(Q,R){const S=Q.lua.lua_touserdata(Q.address,R),T=Q.lua.module.getValue(S,"*");return Q.lua.getRef(T)}pushValue(Q,R){return R.options.reference?super.pushValue(Q,R):!1}close(){this.thread.lua.module.removeFunction(this.gcPointer)}};function K(Q){return new J(Q)}var L=class{global;constructor(Q,{openStandardLibs:R=!0,injectObjects:S=!1,enableProxy:T=!0,traceAllocations:U=!1,functionTimeout:V=void 0}={}){this.cmodule=Q,this.global=new r(this.cmodule,U),this.global.registerTypeExtension(0,aa(this.global)),this.global.registerTypeExtension(0,y(this.global,{functionTimeout:V})),this.global.registerTypeExtension(1,D(this.global,S)),S&&this.global.registerTypeExtension(5,A(this.global)),T?this.global.registerTypeExtension(3,G(this.global)):this.global.registerTypeExtension(1,u(this.global,S)),this.global.registerTypeExtension(4,K(this.global)),R&&this.cmodule.luaL_openlibs(this.global.address)}doString(Q){return this.callByteCode(R=>R.loadString(Q))}doFile(Q){return this.callByteCode(R=>R.loadFile(Q))}doStringSync(Q){this.global.loadString(Q);const R=this.global.runSync();return R[0]}doFileSync(Q){this.global.loadFile(Q);const R=this.global.runSync();return R[0]}async callByteCode(Q){const R=this.global.newThread(),S=this.global.getTop();try{Q(R);const T=await R.run(0);if(T.length>0)return R.getValue(R.getTop()-T.length+1);return}finally{this.global.remove(S)}}},M="1.16.0";function N(){return Promise.resolve({})}var O=class Q{static async initialize(R,S){const T=await N({locateFile:(U,V)=>R||V+U,preRun:U=>{typeof S=="object"&&Object.entries(S).forEach(([V,W])=>U.ENV[V]=W)}});return new Q(T)}module;luaL_checkversion_;luaL_getmetafield;luaL_callmeta;luaL_tolstring;luaL_argerror;luaL_typeerror;luaL_checklstring;luaL_optlstring;luaL_checknumber;luaL_optnumber;luaL_checkinteger;luaL_optinteger;luaL_checkstack;luaL_checktype;luaL_checkany;luaL_newmetatable;luaL_setmetatable;luaL_testudata;luaL_checkudata;luaL_where;luaL_fileresult;luaL_execresult;luaL_ref;luaL_unref;luaL_loadfilex;luaL_loadbufferx;luaL_loadstring;luaL_newstate;luaL_len;luaL_addgsub;luaL_gsub;luaL_setfuncs;luaL_getsubtable;luaL_traceback;luaL_requiref;luaL_buffinit;luaL_prepbuffsize;luaL_addlstring;luaL_addstring;luaL_addvalue;luaL_pushresult;luaL_pushresultsize;luaL_buffinitsize;lua_newstate;lua_close;lua_newthread;lua_resetthread;lua_atpanic;lua_version;lua_absindex;lua_gettop;lua_settop;lua_pushvalue;lua_rotate;lua_copy;lua_checkstack;lua_xmove;lua_isnumber;lua_isstring;lua_iscfunction;lua_isinteger;lua_isuserdata;lua_type;lua_typename;lua_tonumberx;lua_tointegerx;lua_toboolean;lua_tolstring;lua_rawlen;lua_tocfunction;lua_touserdata;lua_tothread;lua_topointer;lua_arith;lua_rawequal;lua_compare;lua_pushnil;lua_pushnumber;lua_pushinteger;lua_pushlstring;lua_pushstring;lua_pushcclosure;lua_pushboolean;lua_pushlightuserdata;lua_pushthread;lua_getglobal;lua_gettable;lua_getfield;lua_geti;lua_rawget;lua_rawgeti;lua_rawgetp;lua_createtable;lua_newuserdatauv;lua_getmetatable;lua_getiuservalue;lua_setglobal;lua_settable;lua_setfield;lua_seti;lua_rawset;lua_rawseti;lua_rawsetp;lua_setmetatable;lua_setiuservalue;lua_callk;lua_pcallk;lua_load;lua_dump;lua_yieldk;lua_resume;lua_status;lua_isyieldable;lua_setwarnf;lua_warning;lua_error;lua_next;lua_concat;lua_len;lua_stringtonumber;lua_getallocf;lua_setallocf;lua_toclose;lua_closeslot;lua_getstack;lua_getinfo;lua_getlocal;lua_setlocal;lua_getupvalue;lua_setupvalue;lua_upvalueid;lua_upvaluejoin;lua_sethook;lua_gethook;lua_gethookmask;lua_gethookcount;lua_setcstacklimit;luaopen_base;luaopen_coroutine;luaopen_table;luaopen_io;luaopen_os;luaopen_string;luaopen_utf8;luaopen_math;luaopen_debug;luaopen_package;luaL_openlibs;referenceTracker=new WeakMap;referenceMap=new Map;availableReferences=[];lastRefIndex;constructor(R){this.module=R,this.luaL_checkversion_=this.cwrap("luaL_checkversion_",null,["number","number","number"]),this.luaL_getmetafield=this.cwrap("luaL_getmetafield","number",["number","number","string"]),this.luaL_callmeta=this.cwrap("luaL_callmeta","number",["number","number","string"]),this.luaL_tolstring=this.cwrap("luaL_tolstring","string",["number","number","number"]),this.luaL_argerror=this.cwrap("luaL_argerror","number",["number","number","string"]),this.luaL_typeerror=this.cwrap("luaL_typeerror","number",["number","number","string"]),this.luaL_checklstring=this.cwrap("luaL_checklstring","string",["number","number","number"]),this.luaL_optlstring=this.cwrap("luaL_optlstring","string",["number","number","string","number"]),this.luaL_checknumber=this.cwrap("luaL_checknumber","number",["number","number"]),this.luaL_optnumber=this.cwrap("luaL_optnumber","number",["number","number","number"]),this.luaL_checkinteger=this.cwrap("luaL_checkinteger","number",["number","number"]),this.luaL_optinteger=this.cwrap("luaL_optinteger","number",["number","number","number"]),this.luaL_checkstack=this.cwrap("luaL_checkstack",null,["number","number","string"]),this.luaL_checktype=this.cwrap("luaL_checktype",null,["number","number","number"]),this.luaL_checkany=this.cwrap("luaL_checkany",null,["number","number"]),this.luaL_newmetatable=this.cwrap("luaL_newmetatable","number",["number","string"]),this.luaL_setmetatable=this.cwrap("luaL_setmetatable",null,["number","string"]),this.luaL_testudata=this.cwrap("luaL_testudata","number",["number","number","string"]),this.luaL_checkudata=this.cwrap("luaL_checkudata","number",["number","number","string"]),this.luaL_where=this.cwrap("luaL_where",null,["number","number"]),this.luaL_fileresult=this.cwrap("luaL_fileresult","number",["number","number","string"]),this.luaL_execresult=this.cwrap("luaL_execresult","number",["number","number"]),this.luaL_ref=this.cwrap("luaL_ref","number",["number","number"]),this.luaL_unref=this.cwrap("luaL_unref",null,["number","number","number"]),this.luaL_loadfilex=this.cwrap("luaL_loadfilex","number",["number","string","string"]),this.luaL_loadbufferx=this.cwrap("luaL_loadbufferx","number",["number","string|number","number","string|number","string"]),this.luaL_loadstring=this.cwrap("luaL_loadstring","number",["number","string"]),this.luaL_newstate=this.cwrap("luaL_newstate","number",[]),this.luaL_len=this.cwrap("luaL_len","number",["number","number"]),this.luaL_addgsub=this.cwrap("luaL_addgsub",null,["number","string","string","string"]),this.luaL_gsub=this.cwrap("luaL_gsub","string",["number","string","string","string"]),this.luaL_setfuncs=this.cwrap("luaL_setfuncs",null,["number","number","number"]),this.luaL_getsubtable=this.cwrap("luaL_getsubtable","number",["number","number","string"]),this.luaL_traceback=this.cwrap("luaL_traceback",null,["number","number","string","number"]),this.luaL_requiref=this.cwrap("luaL_requiref",null,["number","string","number","number"]),this.luaL_buffinit=this.cwrap("luaL_buffinit",null,["number","number"]),this.luaL_prepbuffsize=this.cwrap("luaL_prepbuffsize","string",["number","number"]),this.luaL_addlstring=this.cwrap("luaL_addlstring",null,["number","string","number"]),this.luaL_addstring=this.cwrap("luaL_addstring",null,["number","string"]),this.luaL_addvalue=this.cwrap("luaL_addvalue",null,["number"]),this.luaL_pushresult=this.cwrap("luaL_pushresult",null,["number"]),this.luaL_pushresultsize=this.cwrap("luaL_pushresultsize",null,["number","number"]),this.luaL_buffinitsize=this.cwrap("luaL_buffinitsize","string",["number","number","number"]),this.lua_newstate=this.cwrap("lua_newstate","number",["number","number"]),this.lua_close=this.cwrap("lua_close",null,["number"]),this.lua_newthread=this.cwrap("lua_newthread","number",["number"]),this.lua_resetthread=this.cwrap("lua_resetthread","number",["number"]),this.lua_atpanic=this.cwrap("lua_atpanic","number",["number","number"]),this.lua_version=this.cwrap("lua_version","number",["number"]),this.lua_absindex=this.cwrap("lua_absindex","number",["number","number"]),this.lua_gettop=this.cwrap("lua_gettop","number",["number"]),this.lua_settop=this.cwrap("lua_settop",null,["number","number"]),this.lua_pushvalue=this.cwrap("lua_pushvalue",null,["number","number"]),this.lua_rotate=this.cwrap("lua_rotate",null,["number","number","number"]),this.lua_copy=this.cwrap("lua_copy",null,["number","number","number"]),this.lua_checkstack=this.cwrap("lua_checkstack","number",["number","number"]),this.lua_xmove=this.cwrap("lua_xmove",null,["number","number","number"]),this.lua_isnumber=this.cwrap("lua_isnumber","number",["number","number"]),this.lua_isstring=this.cwrap("lua_isstring","number",["number","number"]),this.lua_iscfunction=this.cwrap("lua_iscfunction","number",["number","number"]),this.lua_isinteger=this.cwrap("lua_isinteger","number",["number","number"]),this.lua_isuserdata=this.cwrap("lua_isuserdata","number",["number","number"]),this.lua_type=this.cwrap("lua_type","number",["number","number"]),this.lua_typename=this.cwrap("lua_typename","string",["number","number"]),this.lua_tonumberx=this.cwrap("lua_tonumberx","number",["number","number","number"]),this.lua_tointegerx=this.cwrap("lua_tointegerx","number",["number","number","number"]),this.lua_toboolean=this.cwrap("lua_toboolean","number",["number","number"]),this.lua_tolstring=this.cwrap("lua_tolstring","string",["number","number","number"]),this.lua_rawlen=this.cwrap("lua_rawlen","number",["number","number"]),this.lua_tocfunction=this.cwrap("lua_tocfunction","number",["number","number"]),this.lua_touserdata=this.cwrap("lua_touserdata","number",["number","number"]),this.lua_tothread=this.cwrap("lua_tothread","number",["number","number"]),this.lua_topointer=this.cwrap("lua_topointer","number",["number","number"]),this.lua_arith=this.cwrap("lua_arith",null,["number","number"]),this.lua_rawequal=this.cwrap("lua_rawequal","number",["number","number","number"]),this.lua_compare=this.cwrap("lua_compare","number",["number","number","number","number"]),this.lua_pushnil=this.cwrap("lua_pushnil",null,["number"]),this.lua_pushnumber=this.cwrap("lua_pushnumber",null,["number","number"]),this.lua_pushinteger=this.cwrap("lua_pushinteger",null,["number","number"]),this.lua_pushlstring=this.cwrap("lua_pushlstring","string",["number","string|number","number"]),this.lua_pushstring=this.cwrap("lua_pushstring","string",["number","string|number"]),this.lua_pushcclosure=this.cwrap("lua_pushcclosure",null,["number","number","number"]),this.lua_pushboolean=this.cwrap("lua_pushboolean",null,["number","number"]),this.lua_pushlightuserdata=this.cwrap("lua_pushlightuserdata",null,["number","number"]),this.lua_pushthread=this.cwrap("lua_pushthread","number",["number"]),this.lua_getglobal=this.cwrap("lua_getglobal","number",["number","string"]),this.lua_gettable=this.cwrap("lua_gettable","number",["number","number"]),this.lua_getfield=this.cwrap("lua_getfield","number",["number","number","string"]),this.lua_geti=this.cwrap("lua_geti","number",["number","number","number"]),this.lua_rawget=this.cwrap("lua_rawget","number",["number","number"]),this.lua_rawgeti=this.cwrap("lua_rawgeti","number",["number","number","number"]),this.lua_rawgetp=this.cwrap("lua_rawgetp","number",["number","number","number"]),this.lua_createtable=this.cwrap("lua_createtable",null,["number","number","number"]),this.lua_newuserdatauv=this.cwrap("lua_newuserdatauv","number",["number","number","number"]),this.lua_getmetatable=this.cwrap("lua_getmetatable","number",["number","number"]),this.lua_getiuservalue=this.cwrap("lua_getiuservalue","number",["number","number","number"]),this.lua_setglobal=this.cwrap("lua_setglobal",null,["number","string"]),this.lua_settable=this.cwrap("lua_settable",null,["number","number"]),this.lua_setfield=this.cwrap("lua_setfield",null,["number","number","string"]),this.lua_seti=this.cwrap("lua_seti",null,["number","number","number"]),this.lua_rawset=this.cwrap("lua_rawset",null,["number","number"]),this.lua_rawseti=this.cwrap("lua_rawseti",null,["number","number","number"]),this.lua_rawsetp=this.cwrap("lua_rawsetp",null,["number","number","number"]),this.lua_setmetatable=this.cwrap("lua_setmetatable","number",["number","number"]),this.lua_setiuservalue=this.cwrap("lua_setiuservalue","number",["number","number","number"]),this.lua_callk=this.cwrap("lua_callk",null,["number","number","number","number","number"]),this.lua_pcallk=this.cwrap("lua_pcallk","number",["number","number","number","number","number","number"]),this.lua_load=this.cwrap("lua_load","number",["number","number","number","string","string"]),this.lua_dump=this.cwrap("lua_dump","number",["number","number","number","number"]),this.lua_yieldk=this.cwrap("lua_yieldk","number",["number","number","number","number"]),this.lua_resume=this.cwrap("lua_resume","number",["number","number","number","number"]),this.lua_status=this.cwrap("lua_status","number",["number"]),this.lua_isyieldable=this.cwrap("lua_isyieldable","number",["number"]),this.lua_setwarnf=this.cwrap("lua_setwarnf",null,["number","number","number"]),this.lua_warning=this.cwrap("lua_warning",null,["number","string","number"]),this.lua_error=this.cwrap("lua_error","number",["number"]),this.lua_next=this.cwrap("lua_next","number",["number","number"]),this.lua_concat=this.cwrap("lua_concat",null,["number","number"]),this.lua_len=this.cwrap("lua_len",null,["number","number"]),this.lua_stringtonumber=this.cwrap("lua_stringtonumber","number",["number","string"]),this.lua_getallocf=this.cwrap("lua_getallocf","number",["number","number"]),this.lua_setallocf=this.cwrap("lua_setallocf",null,["number","number","number"]),this.lua_toclose=this.cwrap("lua_toclose",null,["number","number"]),this.lua_closeslot=this.cwrap("lua_closeslot",null,["number","number"]),this.lua_getstack=this.cwrap("lua_getstack","number",["number","number","number"]),this.lua_getinfo=this.cwrap("lua_getinfo","number",["number","string","number"]),this.lua_getlocal=this.cwrap("lua_getlocal","string",["number","number","number"]),this.lua_setlocal=this.cwrap("lua_setlocal","string",["number","number","number"]),this.lua_getupvalue=this.cwrap("lua_getupvalue","string",["number","number","number"]),this.lua_setupvalue=this.cwrap("lua_setupvalue","string",["number","number","number"]),this.lua_upvalueid=this.cwrap("lua_upvalueid","number",["number","number","number"]),this.lua_upvaluejoin=this.cwrap("lua_upvaluejoin",null,["number","number","number","number","number"]),this.lua_sethook=this.cwrap("lua_sethook",null,["number","number","number","number"]),this.lua_gethook=this.cwrap("lua_gethook","number",["number"]),this.lua_gethookmask=this.cwrap("lua_gethookmask","number",["number"]),this.lua_gethookcount=this.cwrap("lua_gethookcount","number",["number"]),this.lua_setcstacklimit=this.cwrap("lua_setcstacklimit","number",["number","number"]),this.luaopen_base=this.cwrap("luaopen_base","number",["number"]),this.luaopen_coroutine=this.cwrap("luaopen_coroutine","number",["number"]),this.luaopen_table=this.cwrap("luaopen_table","number",["number"]),this.luaopen_io=this.cwrap("luaopen_io","number",["number"]),this.luaopen_os=this.cwrap("luaopen_os","number",["number"]),this.luaopen_string=this.cwrap("luaopen_string","number",["number"]),this.luaopen_utf8=this.cwrap("luaopen_utf8","number",["number"]),this.luaopen_math=this.cwrap("luaopen_math","number",["number"]),this.luaopen_debug=this.cwrap("luaopen_debug","number",["number"]),this.luaopen_package=this.cwrap("luaopen_package","number",["number"]),this.luaL_openlibs=this.cwrap("luaL_openlibs",null,["number"])}lua_remove(R,S){this.lua_rotate(R,S,-1),this.lua_pop(R,1)}lua_pop(R,S){this.lua_settop(R,-S-1)}luaL_getmetatable(R,S){return this.lua_getfield(R,j,S)}lua_yield(R,S){return this.lua_yieldk(R,S,0,null)}lua_upvalueindex(R){return j-R}ref(R){const S=this.referenceTracker.get(R);if(S)return S.refCount++,S.index;const T=this.availableReferences.pop(),U=T===void 0?this.referenceMap.size+1:T;return this.referenceMap.set(U,R),this.referenceTracker.set(R,{refCount:1,index:U}),this.lastRefIndex=U,U}unref(R){const S=this.referenceMap.get(R);if(S===void 0)return;const T=this.referenceTracker.get(S);if(T===void 0){this.referenceTracker.delete(S),this.availableReferences.push(R);return}T.refCount--,T.refCount<=0&&(this.referenceTracker.delete(S),this.referenceMap.delete(R),this.availableReferences.push(R))}getRef(R){return this.referenceMap.get(R)}getLastRefIndex(){return this.lastRefIndex}printRefs(){for(const[R,S]of this.referenceMap.entries())console.log(R,S)}cwrap(R,S,T){const U=T.some(V=>V==="string|number");return U?(...V)=>{const W=[],X=T.map((Y,Z)=>{if(Y==="string|number"){if(typeof V[Z]=="number")return"number";if(V[Z]?.length>1024){const $=this.module.stringToNewUTF8(V[Z]);return V[Z]=$,W.push($),"number"}return"string"}return Y});try{return this.module.ccall(R,S,X,V)}finally{for(const Y of W)this.module._free(Y)}}:(...V)=>this.module.ccall(R,S,T,V)}},P=class{luaWasmPromise;constructor(Q,R){if(Q===void 0){const S=typeof window=="object"&&typeof window.document<"u"||typeof self=="object"&&self?.constructor?.name==="DedicatedWorkerGlobalScope";S&&(Q=`https://unpkg.com/wasmoon@${M}/dist/glue.wasm`)}this.luaWasmPromise=O.initialize(Q,R)}async mountFile(Q,R){this.mountFileSync(await this.getLuaModule(),Q,R)}mountFileSync(Q,R,S){const T=R.lastIndexOf("/"),U=R.substring(T+1),V=R.substring(0,R.length-U.length-1);if(V.length>0){const W=V.split("/").reverse();let X="";for(;W.length;){const Y=W.pop();if(!Y)continue;const Z=`${X}/${Y}`;try{Q.module.FS.mkdir(Z)}catch{}X=Z}}Q.module.FS.writeFile(R,S)}async createEngine(Q={}){return new L(await this.getLuaModule(),Q)}async getLuaModule(){return this.luaWasmPromise}};exports.Decoration=b,exports.LUAI_MAXSTACK=i,exports.LUA_MULTRET=h,exports.LUA_REGISTRYINDEX=j,exports.LuaEngine=L,exports.LuaEventCodes=l,exports.LuaEventMasks=m,exports.LuaFactory=P,exports.LuaGlobal=r,exports.LuaLibraries=n,exports.LuaMultiReturn=d,exports.LuaRawResult=v,exports.LuaReturn=f,exports.LuaThread=q,exports.LuaTimeoutError=o,exports.LuaType=k,exports.LuaTypeExtension=s,exports.LuaWasm=O,exports.PointerSize=g,exports.decorate=c,exports.decorateFunction=w,exports.decorateProxy=E,exports.decorateUserdata=I});
//# sourceMappingURL=index.umd.js.map